version: 2
jobs:

  mdl:
    docker:
      - image: rsrchboy/mdl
    steps:
      - checkout
      - run: mdl .

  flake8:
    docker:
      - image: python:2.7
    steps:
      - checkout
      - run: pip install flake8
      - run: flake8 ddldump/

  postgres:
    docker:
      - image: python:2.7.14-stretch
      - image: circleci/postgres:9.6.8-alpine
    steps:
      - checkout
      - run:
          name: Install postgresql-client
          command: |
            apt-get update
            apt-get -y install postgresql-client-9.6
      - run: psql -h 127.0.0.1 -U postgres < ddldump_postgres.sql
      - run: python setup.py bdist_wheel
      - run: pip install dist/*
      - run: ddldump --diff=ddldump_postgres.sql postgresql://postgres:postgres@127.0.0.1:5432

  mysql:
    docker:
      - image: python:2.7.14-stretch
      - image: circleci/mysql:5.5 # 5.5 is the latest version of mysql-client available on stretch
    steps:
      - checkout
      - run:
          name: Install mysql-client
          command: |
            apt-get update
            apt-get -y install mysql-client
      - run:
          name: Set up "ddldump" database
          command: mysql -h 127.0.0.1 -e 'CREATE DATABASE IF NOT EXISTS `ddldump`'
      - run: mysql -h 127.0.0.1 -uroot ddldump < ddldump_mysql.sql
      - run: python setup.py bdist_wheel
      - run: pip install dist/*
      - run: ddldump --diff=ddldump_mysql.sql mysql://root:@127.0.0.1:3306/ddldump

workflows:
  version: 2
  phaser:
    jobs:
      - mdl
      - flake8
      - postgres
      - mysql
